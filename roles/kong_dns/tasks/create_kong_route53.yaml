---
- name: Get Kong prod IP
  when: ('dry-run' not in ansible_run_tags)
  set_fact:
    kong_prod_ip: "{{
      lookup(
        'ms3_inc.tavros.kube',
        kubeconfig='~/.kube/config',
        kind='Service',
        namespace='kong',
        resource_name='kong-tavros-prod-kong-kong-proxy'
      ).status.loadBalancer.ingress[0].hostname }}"
  tags: [ kong_dns, route53 requires_cluster ]

- name: Get Kong sandbox IP
  when: ('dry-run' not in ansible_run_tags)
  set_fact:
    kong_sandbox_ip: "{{
      lookup(
        'ms3_inc.tavros.kube',
        kubeconfig='~/.kube/config',
        kind='Service',
        namespace='kong',
        resource_name='kong-tavros-sandbox-kong-kong-proxy'
      ).status.loadBalancer.ingress[0].hostname }}"
  tags: [ kong_dns, route53 requires_cluster ]

- name: Set wildcard record for prod
  when: ('dry-run' not in ansible_run_tags)
  community.aws.route53:
    state: present
    zone: "{{ kubernetes_cluster.dns_zone }}"
    type: CNAME
    record: "*.{{ cluster_fqdn }}"
    value: "{{ kong_external_lb }}"
    overwrite: true
    wait: yes
    wait_timeout: 900
  tags: [ kong_dns, route53, requires_cluster ]

- name: Set wildcard for prod ingress name
  when: ('dry-run' not in ansible_run_tags) and (item.ingress_class == kong.default_ingress_class)
  community.aws.route53:
    state: present
    zone: "{{ kubernetes_cluster.dns_zone }}"
    type: CNAME
    record: "*.{{ item.name }}.{{ cluster_fqdn }}"
    value: "{{ kong_external_lb }}"
    overwrite: true
    wait: yes
    wait_timeout: 900
  loop: "{{ kong.instances }}"
  tags: [ kong_dns, route53, requires_cluster ]

- name: Set wildcard for sandbox
  when: ('dry-run' not in ansible_run_tags) and (item.ingress_class != kong.default_ingress_class)
  community.aws.route53:
    state: present
    zone: "{{ kubernetes_cluster.dns_zone }}"
    type: CNAME
    record: "*.{{ item.ingress_class }}.{{ cluster_fqdn }}"
    value: "{{ kong_external_lb }}"
    overwrite: true
    wait: yes
    wait_timeout: 900
  loop: "{{ kong.instances }}"
  tags: [ kong_dns, route53, requires_cluster ]

- name: Set wildcard for sandbox by name
  when: ('dry-run' not in ansible_run_tags) and (item.ingress_class != kong.default_ingress_class)
  community.aws.route53:
    state: present
    zone: "{{ kubernetes_cluster.dns_zone }}"
    type: CNAME
    record: "*.{{ item.name }}.{{ cluster_fqdn }}"
    value: "{{ kong_external_lb }}"
    overwrite: true
    wait: yes
    wait_timeout: 900
  loop: "{{ kong.instances }}"
  tags: [ kong_dns, route53, requires_cluster ]
